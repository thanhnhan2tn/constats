package vn.edu.cit.model;

import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.mapping.Document;

import com.jcraft.jsch.JSch;
import com.jcraft.jsch.JSchException;
import com.jcraft.jsch.Session;

/**
 * Server object with JSCH and Server table in DB
 * 
 * @author Thanh
 *
 */
@Document(collection = "servers")
public class Server {
	@Id
	private int serverId;
	private String serverAddress;
	private int port = 22;
	private String serverName;
	private String serverUsername;
	private String serverPassword;

	public Server() {
		super();
		// TODO Auto-generated constructor stub
	}

	public String getServerName() {
		return serverName;
	}

	public void setServerName(String serverName) {
		this.serverName = serverName;
	}

	public int getServerId() {
		return serverId;
	}

	public Server(int serverId, String serverAddress, int port,
			String serverName, String serverUsername, String serverPassword) {
		super();
		this.serverId = serverId;
		this.serverAddress = serverAddress;
		this.port = port;
		this.serverName = serverName;
		this.serverUsername = serverUsername;
		this.serverPassword = serverPassword;
	}

	public void setServerId(int serverId) {
		this.serverId = serverId;
	}

	public String getServerAddress() {
		return serverAddress;
	}

	public void setServerAddress(String serverAddress) {
		this.serverAddress = serverAddress;
	}

	public int getPort() {
		return port;
	}

	public void setPort(int port) {
		this.port = port;
	}

	public String getServerUsername() {
		return serverUsername;
	}

	public void setServerUsername(String serverUsername) {
		this.serverUsername = serverUsername;
	}

	public String getServerPassword() {
		return serverPassword;
	}

	public void setServerPassword(String serverPassword) {
		this.serverPassword = serverPassword;
	}

	/**
	 * Check Server Status
	 * 
	 * @param sv
	 * @return
	 */
	public boolean checkStatus() {
		return (getSession(this) != null);
	}

	/**
	 * Get Session
	 * 
	 * @param sv
	 * @return
	 */
	public Session getSession(Server sv) {

		try {
			java.util.Properties config = new java.util.Properties();
			config.put("StrictHostKeyChecking", "no");
			JSch jsch = new JSch();
			// Khoi tao doi tuong Session
			Session session = jsch.getSession(sv.getServerUsername(),
					sv.getServerAddress(), sv.getPort());
			session.setPassword(sv.getServerPassword());
			session.setConfig(config);
			session.connect();
			// System.out.println("Connected to Server Success !!!!");
			return session;
		} catch (Exception e) {
			return null;
		}

	}

	@Override
	public String toString() {
		if(this.checkStatus()){
			String str;
			str+="<a href=\"${pageContext.request.contextPath }/monitor/"+this.getServerAddress()+"/${cc}";
			str+="title=\"Monitoring...\"><i class=\"fa fa-desktop server-icon\"></i>";
			str+="<ul class=\"server-info\">";
			str+="<li>Name: <span>Server DNS</span></li>";
			str+="<li>IP: <span><%=server.getServerAddress()%></span></li>";
			str+="<li>CPU: <span>10%</span></li>";
			str+="<li>RAM: <span>50%</span></li>";
			str+="<li>DISK: <span>20%</span></li></ul></a>";
			str+="<div class=\"control-action\">";
			str+="<div class=\"btn-group\" role=\"group\" aria-label=\"...\">";
			str+="<button type=\"button\" class=\"btn btn-danger\"";
						str+="onclick=\"location.href='${pageContext.request.contextPath }/shutdown/"+this.getServerAddress()+"/${cc }'";
						str+="title=\"shutdown\"> ";
						str+="<i class=\"glyphicon glyphicon-off\"></i> </button>";
					str+="<button type=\"button\" class=\"btn btn-warning\"";
					str+="onclick=\"location.href='${pageContext.request.contextPath }/restart/"+this.getServerAddress()+"/${cc }'";
						title="restart">
						<i class="glyphicon glyphicon-repeat"></i>
					</button>
					<div class="btn-group" role="group">
						<button type="button" class="btn btn-default dropdown-toggle"
							data-toggle="dropdown" aria-expanded="false" id="services-config">
							<i class="glyphicon glyphicon-cog"></i>
						</button>
						<ul class="dropdown-menu" role="menu"
							area-labelledby="services-config">
							<li role="presentation" class="dropdown-header">..:ACTION:..</li>
							<li role="presentation"><a role="menuitem" tabindex="-1"
								href="${pageContext.request.contextPath }/editserver/<%=server.getServerAddress()%>/${cc}">Edit...</a></li>
							<li role="presentation"><a role="menuitem" tabindex="-1"
								href="${pageContext.request.contextPath }/removeserver/<%=server.getServerAddress()%>/${cc}">Remove...</a></li>
							<li role="presentation" class="dropdown-header">..:CONFIG:..</li>
							<li role="presentation"><a role="menuitem" tabindex="-1"
								href="${pageContext.request.contextPath }/serviceconfig/nic/<%=server.getServerAddress()%>/${cc}">NetwordCard...</a></li>
							<li role="presentation"><a role="menuitem" tabindex="-1"
								href="${pageContext.request.contextPath }/serviceconfig/dns/<%=server.getServerAddress()%>/${cc}">DNS
									Service...</a></li>
						</ul>
					</div>
				</div>
				</div>
		}
	}
}
